# 历史数据库接口
## 概述
用于批次报表工具访问DCS历史数据库的编程接口，允许批次报表工具在收集报表数据时与DCS历史数据库进行交互，从而获取时序数据。<br>
本次定义范围包括请求体、响应体和异常处理规则，暂不包含具体通信协议，后续可考虑选用RESTful API / gRPC。<br>
该接口旨在简化历史数据的采集和管理过程，上位系统可通过该接口高效地利用DCS历史数据，而无需重复开发历史数据库。



## 接口定义

### 接口功能
- 在指定时间范围内按指定间隔获取历史数据
- 在指定时间范围内获取历史数据统计值（最大值、最小值、平均值）
- 允许在一次请求响应中获取多个变量的历史数据，数据按变量组织，以顺序表的形式返回
- 具有异常响应和处理机制，确保数据请求的可靠性


### 请求体
| Key | Description |
|-----|-------------|
| tags | 包含本次查询所有目标变量的列表|
| filter | 查询条件过滤器，以键值对形式表示，条件之间互为与关系，包含条件见下表|

#### filter包含的查询条件
| Name | Description |
|------|-------------|
| type | 查询类型，支持 "raw"/"max"/"min"/"avg"<br>Note: 仅type为"raw"时interval有效 |
| start_time | 查询起始时间，支持时间戳 |
| end_time | 查询结束时间，支持时间戳 |
| interval | 查询时间间隔，单位：秒 |

#### 示例
```
查询TT_01和PT_01在2025-07-01 15:00:00至2025-07-01 18:00:00之间的原始历史数据，时间间隔为30分钟
```
```yaml
"tags": ["TT_01", "PT_01"]
"filter": {
    "type": "raw",
    "start_time": "1751324400",
    "end_time": "1751364000",
    "interval": 1800
}
```


### 响应体
包含每个变量的查询结果与质量，按变量组织，结果以顺序表的形式表示。<br>
#### 结构
```
{
  - tag1: {
    - state
    - period
    - values
    - qualitys
  },
  "tag2": {
    ...
  },
  ...
}
```
#### 字段
| Key | Description |
|-----|-------------|
| tag | 变量名 |
| state | 状态码 |
| period | 实际查询的起始时间和结束时间，均为时间戳，用于校验 |
| values | 包含变量所有查询时间点的值的列表 |
| qualitys | 质量戳列表，对应时间点值的质量，长度与values相同 |


#### 示例
```yaml
"TT_01": {
  "state": 200,
  "period": ["1751324400", "1751364000"],
  "values": [70.11, 70.12, 70.14, 70.13, 70.15, 70.16, 70.14],
  "qualitys": [0, 0, 0, 0, 0, 0, 0]
}
"PT_01": {
  "state": 200,
  "period": ["1751324400", "1751364000"],
  "values": [120, 130, 140, 145, 140, 135, 140],
  "qualitys": [0, 0, 0, 0, 0, 0, 0]
}
```


## 异常响应与处理

### 质量戳
- #### 0：正常
  - 说明：数据正常
  - 处理：正常返回数据
- #### 1：质量异常
  - 说明： DCS变量自带的质量戳异常
  - 处理：标记Quality为1，返回原始值，由客户端自行处理
- #### 2：数据缺失
  - 说明：请求的时间点处，历史值不存在
  - 处理：标记Quality为2，返回前后时间点值计算的平均值插值
- #### 3：数据异常
  - 说明：请求的时间点处，历史值明显异常，例如[70.1, 150, 70.2]
  - 处理：标记Quality为3，返回前后时间点值计算的平均值插值


### 状态码
- #### 200: 全部请求成功
  - 说明：请求成功，返回数据
  - 处理：无异常，正常返回数据
- #### 206: 部分请求成功
  - 说明：部分点请求成功，部分点请求失败
  - 处理：正常返回数据，客户端需根据quality检查每个tag的状态
- #### 400：参数不合法
  - 说明：请求参数不合法，例如缺少参数、时间倒置、interval<0等
  - 处理：返回错误码和错误信息，客户端需检查请求参数
- #### 404：tag不存在
  - 说明：请求的tag不存在
  - 处理：返回错误码和错误信息，客户端需检查tags列表
- #### 405：点数超限
  - 说明：点数过多，超过历史数据库接口的限制
  - 处理：返回错误码和错误信息，客户端需减少tag数量后重试
- #### 406: 时间段超限
  - 说明：时间段过长，超过历史数据库接口的限制
  - 处理：返回错误码和错误信息，客户端需缩短时间长度后重试
- #### 500: 服务不可用
  - 说明：历史数据库服务不可用
  - 处理：返回错误码和错误信息，客户端需稍后重试
- #### 503: 请求超时
  - 说明：请求超时，可能由于网络问题或服务端处理时间过长
  - 处理：返回错误码和错误信息，客户端可选择重试请求

### 说明
- 无论本次请求是否正常，服务器都应返回固定结构，客户端根据每个tag中state字段对应的状态码进行解析与处理。


## IoTDB
###